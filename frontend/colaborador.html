<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>MVP Desk - Colaborador</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <img src="MVPDESK.png" alt="Logo do Sistema">
</header>
<div class="container">
  <h2 id="boasVindas"></h2>

  <section class="menu">
    <h2>Menu</h2>
    <button onclick="abrirChamado()">Abrir Chamado</button>
    <button onclick="carregarHistorico()">Hist√≥rico</button>
    <button onclick="mostrarFAQ()">FAQ</button>
    <div id="conteudo"></div>
  </section>
</div>

<footer>
  <button class="btn-voltar" onclick="logout()">‚Üê Sair</button>
</footer>

<script>
// Vari√°vel 'usuario' deve ser definida fora das fun√ß√µes
const usuario = JSON.parse(sessionStorage.getItem("usuario"));
if (!usuario) {
  alert("Fa√ßa login primeiro!");
  window.location.href = "index.html";
}
document.getElementById("boasVindas").innerText =
  `Bem-vindo, ${usuario.Nome}`;

function logout() {
  // Adiciona a caixa de confirma√ß√£o
  const confirma = confirm("Tem certeza que deseja sair?");
  
  if (confirma) {
    sessionStorage.clear();
    window.location.href = "index.html";
  }
  // Se o usu√°rio clicar em "Cancelar", a fun√ß√£o termina aqui e a p√°gina n√£o muda.
}

// NOVA FUN√á√ÉO UTILIT√ÅRIA: Escapa caracteres HTML para inje√ß√£o segura
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, (m) => map[m]);
}


// --------------------------------------------------------------------------------------------------
// 1. FUN√á√ÉO PARA EXIBIR O FORMUL√ÅRIO DE ABERTURA
// --------------------------------------------------------------------------------------------------
function abrirChamado() {
  document.getElementById("conteudo").innerHTML = `
    <h3>Abertura de Chamado</h3>
    <select id="categoria">
      <option value="">Categoria</option>
      <option value="Hardware">Hardware</option>
      <option value="Software">Software</option>
      <option value="Outros">Outros</option>
    </select>
    <textarea id="descricao" placeholder="Descreva o problema..."></textarea>
    <button onclick="iniciarRegistro()">Registrar</button>
    <div id="sugestao-ia"></div>
  `;
}

// --------------------------------------------------------------------------------------------------
// 2. FUN√á√ÉO PRINCIPAL: CHAMA A IA ANTES DE REGISTRAR
// --------------------------------------------------------------------------------------------------
async function iniciarRegistro() {
  const categoria = document.getElementById("categoria").value;
  const descricao = document.getElementById("descricao").value;

  if (!categoria || !descricao) {
    alert("Preencha a categoria e a descri√ß√£o do problema.");
    return;
  }

  // Desabilita o bot√£o para evitar cliques m√∫ltiplos
  const btn = document.querySelector("#conteudo button");
  btn.innerText = "Buscando sugest√£o do MVPzinho...";
  btn.disabled = true;

  try {
    // üìû Chama a rota /sugerir da API de IA (unificada no server.js)
    const respIA = await fetch("http://localhost:3000/sugerir", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ descricao })
    });

    const dataIA = await respIA.json();
    
    // Verifica se a IA retornou uma sugest√£o
    if (dataIA.sugestao) {
      exibirSugestao(dataIA.sugestao, categoria, descricao);
    } else {
      // Se falhou ou n√£o retornou sugest√£o, registra direto (plano B)
      alert("O MVPzinho n√£o conseguiu gerar uma sugest√£o. O chamado ser√° registrado para o t√©cnico.");
      await registrarChamadoNoBanco(categoria, descricao);
    }
  } catch (error) {
    console.error(error);
    alert("Erro de comunica√ß√£o com o servidor de IA. Registrando chamado tradicionalmente.");
    await registrarChamadoNoBanco(categoria, descricao);
  } finally {
    // Reabilita o bot√£o se n√£o houver redirecionamento ou a√ß√£o final
    btn.innerText = "Registrar";
    btn.disabled = false;
  }
}

// 3. EXIBE A SUGEST√ÉO E AS OP√á√ïES
// --------------------------------------------------------------------------------------------------
function exibirSugestao(sugestao, categoria, descricao) {
  const elementoSugestao = document.getElementById("sugestao-ia");
  
  // ‚≠êÔ∏è UTILIZA escapeHtml() para seguran√ßa e depois substitui * por <li>
  // Substitui cada linha que come√ßa com "* " por <li>
  let sugestaoFormatada = escapeHtml(sugestao);
  sugestaoFormatada = sugestaoFormatada.replace(/\* (.*)/g, '<li>$1</li>');
  sugestaoFormatada = `<ul>${sugestaoFormatada}</ul>`; // Envolve tudo em <ul>

  
  elementoSugestao.innerHTML = `
    <hr>
    <h4>üí° Sugest√£o da Solu√ß√£o (IA)</h4>
    <div style="background: #eaf6ff; padding: 15px; border-radius: 8px; border-left: 5px solid #3498db;">
      ${sugestaoFormatada}
    </div>
    <p><strong>A sugest√£o da IA resolveu seu problema?</strong></p>
    <button onclick="problemaResolvido()">Sim, resolveu!</button>
    <button onclick="encaminharParaTecnico('${categoria}', '${descricao}')" style="background: #e74c3c;">N√£o, preciso do t√©cnico</button>
    <hr>
  `;
}

// --------------------------------------------------------------------------------------------------
// 4. A√á√ÉO: PROBLEMA RESOLVIDO PELA IA
// --------------------------------------------------------------------------------------------------
function problemaResolvido() {
  document.getElementById("conteudo").innerHTML = `
    <h3 style="color: #27ae60;">üéâ Problema Resolvido!</h3>
    <p>Que bom que a sugest√£o do MVPzinho ajudou! N√£o foi necess√°rio registrar o chamado, e voc√™ j√° pode voltar a trabalhar. Caso precise de algo mais, fa√ßa uma nova solicita√ß√£o!</p>
  `;
}

// --------------------------------------------------------------------------------------------------
// 5. A√á√ÉO: REGISTRA O CHAMADO PARA O T√âCNICO
// --------------------------------------------------------------------------------------------------
async function encaminharParaTecnico(categoria, descricao) {
  // Chamado para a fun√ß√£o que realmente registra no banco
  await registrarChamadoNoBanco(categoria, descricao);
}

// --------------------------------------------------------------------------------------------------
// 6. FUN√á√ÉO DE REGISTRO NO BANCO (USADA APENAS SE A IA N√ÉO AJUDAR)
// --------------------------------------------------------------------------------------------------
async function registrarChamadoNoBanco(categoria, descricao) {
  // Necess√°rio obter a vari√°vel global 'usuario' para o ID
  const usuario = JSON.parse(sessionStorage.getItem("usuario"));

  const resp = await fetch("http://localhost:3000/chamados", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuarioId: usuario.UsuarioID, categoria, descricao })
  });

  const data = await resp.json();

  if (data.success) {
      document.getElementById("conteudo").innerHTML = `
        <h3 style="color: #e74c3c;">Chamado Registrado!</h3>
        <p>Sua solicita√ß√£o foi registrada e ser√° encaminhada ao primeiro t√©cnico dispon√≠vel.</p>
      `;
  } else {
      alert("Erro ao registrar chamado. Tente novamente mais tarde.");
      abrirChamado(); // Volta para a tela de abertura
  }
}

// --------------------------------------------------------------------------------------------------
// FUN√á√ïES DE HIST√ìRICO E FAQ
// --------------------------------------------------------------------------------------------------
async function carregarHistorico() {
  const resp = await fetch(`http://localhost:3000/chamados?usuarioId=${usuario.UsuarioID}`);
  const chamados = await resp.json();

  let html = "<h3>Hist√≥rico de Chamados</h3>";
  for (const c of chamados) {
    html += `<div>
      <strong>#${c.ChamadoID} - ${c.Categoria}</strong><br>
      Descri√ß√£o: ${c.Descricao}<br>
      T√©cnico respons√°vel: ${c.NomeTecnico ? c.NomeTecnico : "Ainda n√£o atribu√≠do"}<br>
      Status: ${c.Status}<br>
      <div id="pareceres-${c.ChamadoID}"></div>
    </div><hr>`;
  }

  // primeiro insere o HTML completo
  document.getElementById("conteudo").innerHTML = html;

  // depois carrega os pareceres em cada div
  for (const c of chamados) {
    carregarPareceres(c.ChamadoID);
  }
}

async function carregarPareceres(chamadoId) {
  const resp = await fetch(`http://localhost:3000/pareceres?chamadoId=${chamadoId}`);
  const pareceres = await resp.json();

  if (pareceres.length > 0) {
    let html = "<h4>Pareceres</h4><ul>";
    pareceres.forEach(p => {
      html += `<li><strong>${p.Tecnico}</strong> (${p.DataParecer}): ${p.Texto} [${p.Status}]</li>`;
    });
    html += "</ul>";
    document.getElementById(`pareceres-${chamadoId}`).innerHTML = html;
  }
}

function mostrarFAQ() {
  const html = `
    <h3>FAQ - Perguntas Frequentes</h3>
    <ul>
      <li><strong>1: Meu computador n√£o est√° ligando. O que devo fazer primeiro?</strong><br>
          Verifique se o cabo de energia est√° bem conectado √† tomada e ao computador. Se estiver usando um notebook, teste com o carregador conectado. Caso o problema continue, abra um chamado na categoria "Hardware".</li><br>
      <li><strong>2: Preciso solicitar novos equipamentos (notebook, monitor e headset). Como solicito?</strong><br>
          As solicita√ß√µes de novos equipamentos devem ser registradas atrav√©s da abertura de chamado na categoria "Outros". Informe o equipamento necess√°rio e o motivo da solicita√ß√£o para avalia√ß√£o do setor respons√°vel.</li><br>
      <li><strong>3. O mouse e o teclado pararam de funcionar. O que fazer?</strong><br>
          Primeiro, desconecte e reconecte os dispositivos. Se forem sem fio, verifique pilhas ou bateria. Caso ainda n√£o funcionem, teste em outra porta USB ou em outro computador. Persistindo o problema, abra um chamado em "Hardware".</li><br>
    </ul>
  `;
  document.getElementById("conteudo").innerHTML = html;
}
</script>
</body>
</html>
